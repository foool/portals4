<?xml version="1.0"?>
<test>
  <repeat count="2">
    <subtest>
      <desc>Test put le unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="NO_MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_le_append le_opt="OP_PUT USE_ONCE" uid="ANY">
                <ptl_md>
                  <ptl_put target_id="SELF"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_le_unlink ret="ARG_INVALID"/>
              </ptl_le_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test put me unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_PUT USE_ONCE" uid="ANY" me_match="0x5555">
                <ptl_md>
                  <ptl_put match="0x5555" target_id="SELF"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test put me unlink with min_free not reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_PUT MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555">
                <ptl_md>
                  <ptl_put match="0x5555" length="6" target_id="SELF"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_me_unlink/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test put me unlink with min_free reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_PUT MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555">
                <ptl_md>
                  <ptl_put match="0x5555" length="7" target_id="SELF"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test get le unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="NO_MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_le_append le_opt="OP_GET USE_ONCE" uid="ANY">
                <ptl_md>
                  <ptl_get target_id="SELF"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_le_unlink ret="ARG_INVALID"/>
              </ptl_le_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test get me unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET USE_ONCE" uid="ANY" me_match="0x5555">
                <ptl_md>
                  <ptl_get match="0x5555" target_id="SELF"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test get me unlink with min_free not reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555">
                <ptl_md>
                  <ptl_get match="0x5555" length="6" target_id="SELF"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_me_unlink/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test get me unlink with min_free reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555">
                <ptl_md>
                  <ptl_get match="0x5555" length="7" target_id="SELF"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test atomic le unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="NO_MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_le_append le_opt="OP_GET OP_PUT USE_ONCE" uid="ANY" target_id="SELF">
                <ptl_md>
                  <ptl_atomic/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_le_unlink ret="ARG_INVALID"/>
              </ptl_le_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test atomic me unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET OP_PUT USE_ONCE" uid="ANY" me_match="0x5555" target_id="SELF">
                <ptl_md>
                  <ptl_atomic match="0x5555"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test atomic me unlink with min_free not reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET OP_PUT MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555" target_id="SELF">
                <ptl_md>
                  <ptl_atomic match="0x5555" length="6"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_me_unlink/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test atomic me unlink with min_free reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET OP_PUT MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555" target_id="SELF">
                <ptl_md>
                  <ptl_atomic match="0x5555" length="7"/>
                  <msleep count="10"/>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test fetch atomic le unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="NO_MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_le_append le_opt="OP_GET OP_PUT USE_ONCE" uid="ANY" target_id="SELF">
                <ptl_md>
                  <ptl_md>
                    <ptl_fetch/>
                    <msleep count="10"/>
                  </ptl_md>
                </ptl_md>
                <ptl_le_unlink ret="ARG_INVALID"/>
              </ptl_le_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test fetch atomic me unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET OP_PUT USE_ONCE" uid="ANY" me_match="0x5555" target_id="SELF">
                <ptl_md>
                  <ptl_md>
                    <ptl_fetch match="0x5555"/>
                    <msleep count="10"/>
                  </ptl_md>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test fetch atomic me unlink with min_free not reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET OP_PUT MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555" target_id="SELF">
                <ptl_md>
                  <ptl_md>
                    <ptl_fetch match="0x5555" length="6"/>
                    <msleep count="10"/>
                  </ptl_md>
                </ptl_md>
                <ptl_me_unlink/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test fetch atomic me unlink with min_free reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET OP_PUT MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555" target_id="SELF">
                <ptl_md>
                  <ptl_md>
                    <ptl_fetch match="0x5555" length="7"/>
                    <msleep count="10"/>
                  </ptl_md>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test swap le unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="NO_MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_le_append le_opt="OP_GET OP_PUT USE_ONCE" uid="ANY" target_id="SELF">
                <ptl_md>
                  <ptl_md>
                    <ptl_swap atom_op="SWAP"/>
                    <msleep count="10"/>
                  </ptl_md>
                </ptl_md>
                <ptl_le_unlink ret="ARG_INVALID"/>
              </ptl_le_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test swap me unlink with USE_ONCE</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET OP_PUT USE_ONCE" uid="ANY" me_match="0x5555" target_id="SELF">
                <ptl_md>
                  <ptl_md>
                    <ptl_swap match="0x5555" atom_op="SWAP"/>
                    <msleep count="10"/>
                  </ptl_md>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test swap me unlink with min_free not reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET OP_PUT MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555" target_id="SELF">
                <ptl_md>
                  <ptl_md>
                    <ptl_swap match="0x5555" length="6" atom_op="SWAP"/>
                    <msleep count="10"/>
                  </ptl_md>
                </ptl_md>
                <ptl_me_unlink/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
    <subtest>
      <desc>Test swap me unlink with min_free reached</desc>
      <ptl>
        <ptl_ni ni_opt="MATCH PHYSICAL">
          <ompi_rt>
            <ptl_pt>
              <ptl_me_append me_opt="OP_GET OP_PUT MANAGE_LOCAL" me_length="10" me_min_free="4" uid="ANY" me_match="0x5555" target_id="SELF">
                <ptl_md>
                  <ptl_md>
                    <ptl_swap match="0x5555" length="7" atom_op="SWAP"/>
                    <msleep count="10"/>
                  </ptl_md>
                </ptl_md>
                <ptl_me_unlink ret="ARG_INVALID"/>
              </ptl_me_append>
            </ptl_pt>
          </ompi_rt>
        </ptl_ni>
      </ptl>
    </subtest>
  </repeat>
</test>
